blueprint:
  name: Ouverture automatique portail via Bluetooth voiture
  description: |
    Ouvre automatiquement un portail ou une porte de garage quand un appareil 
    se connecte au Bluetooth d'une voiture ET que cet appareil est physiquement 
    dans la zone d√©finie (g√©n√©ralement la maison).
    
    ‚úÖ V√©rifie que l'appareil qui se connecte est bien dans la bonne zone
    ‚úÖ Emp√™che l'ouverture si quelqu'un se connecte ailleurs
    ‚úÖ Parfait pour automatiser l'arriv√©e sans intervention manuelle
    
  domain: automation
  source_url: https://github.com/Ostenhard/ha/blob/main/blueprints/portail-bluetooth.yaml
  
  input:
    bluetooth_sensor:
      name: Capteur de connexion Bluetooth
      description: |
        Capteur qui d√©tecte les connexions Bluetooth de l'appareil.
        Format: sensor.xxx_bluetooth_connection
        
        Pour activer ce capteur:
        1. App Home Assistant Companion > Param√®tres
        2. G√©rer les capteurs
        3. Activer "Bluetooth Connection"
      selector:
        entity:
          filter:
            - domain: sensor
          
    device_tracker:
      name: Traceur de l'appareil (m√™me appareil)
      description: |
        Device tracker correspondant AU M√äME appareil que le capteur Bluetooth.
        
        ‚ö†Ô∏è IMPORTANT: Ce doit √™tre le m√™me appareil !
        Exemple: si bluetooth_sensor = sensor.sm_a525f_bluetooth_connection
        alors device_tracker = device_tracker.sm_a525f
      selector:
        entity:
          filter:
            - domain: device_tracker
          
    bluetooth_mac_addresses:
      name: Adresses MAC Bluetooth de la voiture
      description: |
        Liste des adresses MAC Bluetooth de votre voiture.
        Format: ["AA:BB:CC:DD:EE:FF", "11:22:33:44:55:66"]
        
        üîç Comment trouver ces adresses:
        1. Connectez votre t√©l√©phone au Bluetooth de la voiture
        2. Home Assistant > Outils d√©veloppeur > √âtats
        3. Cherchez sensor.xxx_bluetooth_connection
        4. Regardez l'attribut "connected_paired_devices"
        5. Copiez les adresses exactement comme affich√©es
        
        üí° Astuce: Vous pouvez mettre plusieurs adresses si votre 
        voiture a plusieurs interfaces Bluetooth (radio, t√©l√©phone, etc.)
      default: []
      selector:
        object:
          
    target_zone:
      name: Zone de d√©clenchement
      description: |
        Zone dans laquelle l'appareil DOIT se trouver pour d√©clencher l'ouverture.
        
        G√©n√©ralement: zone.home (Maison)
        Mais peut √™tre: zone.travail, zone.lycee, etc.
      default: zone.home
      selector:
        entity:
          filter:
            - domain: zone
          
    cover_entity:
      name: Portail ou porte de garage √† ouvrir
      description: |
        Entit√© du portail, porte de garage ou barri√®re √† ouvrir.
      selector:
        entity:
          filter:
            - domain: cover
          
mode: single
max_exceeded: silent

variables:
  bluetooth_addresses: !input bluetooth_mac_addresses

trigger:
  - platform: numeric_state
    entity_id: !input bluetooth_sensor
    above: 0

condition:
  # Condition 1: Le portail doit √™tre ferm√©
  - condition: state
    entity_id: !input cover_entity
    state: closed
    
  # Condition 2: L'appareil qui se connecte DOIT √™tre dans la zone d√©finie
  - condition: zone
    entity_id: !input device_tracker
    zone: !input target_zone
    
  # Condition 3: Le nombre de connexions Bluetooth a augment√© (= connexion, pas d√©connexion)
  - condition: template
    value_template: >
      {% set raw_values = trigger.to_state.attributes.connected_paired_devices %}
      
      {# V√©rifier que raw_values existe et n'est pas None #}
      {% if raw_values is not none and raw_values | length > 0 %}
        {# Extraire uniquement les adresses MAC de chaque √©l√©ment #}
        {# Le regex cherche 17 caract√®res compos√©s de chiffres, lettres A-F et deux-points #}
        
        {% set connectes = raw_values | map('regex_findall', '([0-9A-F:]{17})', ignorecase=True) | map('first') | list %}
                      
        {# Comparer les deux listes propres #}
        {{ connectes | intersect(bluetooth_addresses) | count > 0 }}
      {% else %}
        {# Si pas de donn√©es, la condition √©choue #}
        false
      {% endif %}

action:
  - service: cover.open_cover
    target:
      entity_id: !input cover_entity
    data: {}