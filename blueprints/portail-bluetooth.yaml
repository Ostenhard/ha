blueprint:
  name: Ouverture automatique portail via Bluetooth voiture
  description: |
    Ouvre automatiquement un portail ou une porte de garage quand un appareil 
    se connecte au Bluetooth d'une voiture ET que cet appareil est physiquement 
    dans la zone dÃ©finie (gÃ©nÃ©ralement la maison).
    
    âœ… VÃ©rifie que l'appareil qui se connecte est bien dans la bonne zone
    âœ… EmpÃªche l'ouverture si quelqu'un se connecte ailleurs
    âœ… Parfait pour automatiser l'arrivÃ©e sans intervention manuelle
    
  domain: automation
  source_url: https://github.com/votre-repo/blueprints/portail-bluetooth.yaml
  
  input:
    bluetooth_sensor:
      name: Capteur de connexion Bluetooth
      description: |
        Capteur qui dÃ©tecte les connexions Bluetooth de l'appareil.
        Format: sensor.xxx_bluetooth_connection
        
        Pour activer ce capteur:
        1. App Home Assistant Companion > ParamÃ¨tres
        2. GÃ©rer les capteurs
        3. Activer "Bluetooth Connection"
      selector:
        entity:
          filter:
            - domain: sensor
          
    device_tracker:
      name: Traceur de l'appareil (mÃªme appareil)
      description: |
        Device tracker correspondant AU MÃŠME appareil que le capteur Bluetooth.
        
        âš ï¸ IMPORTANT: Ce doit Ãªtre le mÃªme appareil !
        Exemple: si bluetooth_sensor = sensor.sm_a525f_bluetooth_connection
        alors device_tracker = device_tracker.sm_a525f
      selector:
        entity:
          filter:
            - domain: device_tracker
          
    bluetooth_mac_addresses:
      name: Adresses MAC Bluetooth de la voiture
      description: |
        Liste des adresses MAC Bluetooth de votre voiture.
        Format: ["AA:BB:CC:DD:EE:FF", "11:22:33:44:55:66"]
        
        ðŸ” Comment trouver ces adresses:
        1. Connectez votre tÃ©lÃ©phone au Bluetooth de la voiture
        2. Home Assistant > Outils dÃ©veloppeur > Ã‰tats
        3. Cherchez sensor.xxx_bluetooth_connection
        4. Regardez l'attribut "connected_paired_devices"
        5. Copiez les adresses exactement comme affichÃ©es
        
        ðŸ’¡ Astuce: Vous pouvez mettre plusieurs adresses si votre 
        voiture a plusieurs interfaces Bluetooth (radio, tÃ©lÃ©phone, etc.)
      default: []
      selector:
        object:
          
    target_zone:
      name: Zone de dÃ©clenchement
      description: |
        Zone dans laquelle l'appareil DOIT se trouver pour dÃ©clencher l'ouverture.
        
        GÃ©nÃ©ralement: zone.home (Maison)
        Mais peut Ãªtre: zone.travail, zone.lycee, etc.
      default: zone.home
      selector:
        entity:
          filter:
            - domain: zone
          
    cover_entity:
      name: Portail ou porte de garage Ã  ouvrir
      description: |
        EntitÃ© du portail, porte de garage ou barriÃ¨re Ã  ouvrir.
      selector:
        entity:
          filter:
            - domain: cover
          
mode: single
max_exceeded: silent

variables:
  bluetooth_addresses: !input bluetooth_mac_addresses

trigger:
  - platform: state
    entity_id: !input bluetooth_sensor
    attribute: connected_paired_devices
    to: "{{ bluetooth_addresses }}"

condition:
  # Condition 1: Le portail doit Ãªtre fermÃ©
  - condition: state
    entity_id: !input cover_entity
    state: closed
    
  # Condition 2: L'appareil qui se connecte DOIT Ãªtre dans la zone dÃ©finie
  - condition: zone
    entity_id: !input device_tracker
    zone: !input target_zone
    
  # Condition 3: Le nombre de connexions Bluetooth a augmentÃ© (= connexion, pas dÃ©connexion)
  - condition: template
    value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"

action:
  # Action 1: Ouvrir le portail/garage
  - service: cover.open_cover
    target:
      entity_id: !input cover_entity
    data: {}
